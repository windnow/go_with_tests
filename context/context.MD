Context 
=======

Часто запуск программное обеспечение запускает достаточно долгоие ресурсоемкие процессы (обычно в горутинах). Если действие, вызвавшее их будет по какой то причине отменено, или не выполнено, то необходимо последовательно остановить эти процессы в приложении.

Если не управлять этим, то go приложение может вызвать проблемы с отладкой производительности.

В этой главе мы будем использовать пакет `context` для облегчения управления долго работающими процессами.

Мы начнем с классического примера web сервера, который при необходимости запускает потенциально длительный процесс для извлечения некоторых данных для возврата в ответ.

Мы реализуем сценарий, в котором пользователь отменяет запрос до того, как данные могут быть получены, и убедимся что процесс был остановлен

Я реализовал некоторый статовый код

```go
func Server(store Store) http.HandlerFunc {
    return func(w http.ResponseWriter, r *http.Request){
        fmt.Fprint(w, store.Fetch())
    }
}
```

Функция `Server` принимает `Store` и возвращает `http.HandlerFunc`. `Store` определено следующим образом:

```go
type Store interface {
    Fetch() string
}
```

Возвращаемая функция вызывает метод `Fetch` обЪекта `store` и записывает его в ответ (`response`)

У нас есть соответствующая заглушка для `Store`, которую мы используем в тесте

```go
type StubStore struct {
	response string
}

func (s *StubStore) Fetch() string {
	return s.response
}

func TestHandler(t *testing.T) {
	data := "hello, world"
	srv := Server(&StubStore{data})

	request := httptest.NewRequest(http.MethodGet, "/", nil)
	response := httptest.NewRecorder()

	srv.ServeHTTP(response, request)

	if response.Body.String() != data {
		t.Errorf(`got "%s", want "%s"`, response.Body.String(), data)
	}
}
```
Теперь, когда у нас есть удачный сценарий, необходимо реализовать более реализстичный сценарий, в котором `Store` не может завершить `Fetch` до того, как пользователь отменит запрос.

## Сначал напишем тест
Нашему обработчику потребуется спосом сообщить хранилищу о отмене работы, потому обновим интерфейс 

```go
type Store interface {
	Fetch() string
	Cancel()
}
```